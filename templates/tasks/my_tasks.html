{% extends 'base.html' %}
{% load static %}

{% block title %}ğŸ“Œ Ù…Ù‡Ø§Ù…ÙŠ{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/my_tasks.css' %}">
{% endblock %}

{% block content %}
<h2 class="page-title">ğŸ“Œ Ù…Ù‡Ø§Ù…ÙŠ</h2>

{# âœ… Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† backend #}
{% if messages %}
  <div class="messages">
    {% for message in messages %}
      <div class="alert">{{ message }}</div>
    {% endfor %}
  </div>
{% endif %}

{# âœ… Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙÙ„Ø§ØªØ± #}
<form method="get" class="task-filter-form" style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
     <label>
    Ø¨Ø­Ø«:
    <input type="text" name="q" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ ÙƒØ§ØªØ¨..." value="{{ search_query|default:'' }}">
  </label>
  <label>
    Ø§Ù„Ø­Ø§Ù„Ø©:
    <select name="status">
      <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
      <option value="in_progress" {% if selected_status == "in_progress" %}selected{% endif %}>â³ Ø¬Ø§Ø±ÙŠ</option>
      <option value="upload" {% if selected_status == "upload" %}selected{% endif %}>ğŸ“¤ ØªÙ… Ø§Ù„Ø±ÙØ¹</option>
      <option value="publish" {% if selected_status == "publish" %}selected{% endif %}>ğŸ“¢ ØªÙ… Ø§Ù„Ù†Ø´Ø±</option>
      <option value="done" {% if selected_status == "done" %}selected{% endif %}>âœ… Ù…ÙƒØªÙ…Ù„Ø©</option>
    </select>
  </label>

  <label>
    Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø´Ø±:
    <select name="site">
      <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
      {% for id, name in sites %}
        <option value="{{ id }}" {% if id|stringformat:"s" == selected_site %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>
  </label>

  <button type="submit">ğŸ” ØªØµÙÙŠØ©</button>
  <a href="{% url 'my_tasks' %}" class="reset-filter">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</a>
</form>

{# âœ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… #}
<table class="task-table">
  <thead>
    <tr>
      <th>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚Ø§Ù„</th>
      <th>[Ø§Ù„Ù†ÙˆØ¹]</th>
      <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
      <th>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù‚Ø§Ù„</th>
      <th>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø´Ø±</th>
      <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</th>
    </tr>
  </thead>
  <tbody>
    {% for task in tasks %}
      <tr>
        <td>{{ task.article_title }}</td>
        <td>{{ task.article_type_W_R_A_B }}</td>
        <td>{{ task.article_details }}</td>
        <td>
          <form method="post" action="{% url 'update_article_link' task.id %}">
            {% csrf_token %}
            <input type="url" name="article_link" value="{{ task.article_link }}" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·" required>
            <button type="submit">ğŸ’¾ Ø­ÙØ¸</button>
          </form>
        </td>
        <td>{{ task.publish_site }}</td>
        <td>{{ task.publish_date }}</td>
        <td>
          <form method="post" action="{% url 'update_task_status' task.id %}">
            {% csrf_token %}
            <select name="status" onchange="this.form.submit()">
              <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„</option>
              <option value="upload" {% if task.status == 'upload' %}selected{% endif %}>ğŸ“¤ ØªÙ… Ø§Ù„Ø±ÙØ¹</option>
              <option value="publish" {% if task.status == 'publish' %}selected{% endif %}>ğŸ“¢ ØªÙ… Ø§Ù„Ù†Ø´Ø±</option>
              <option value="done" {% if task.status == 'done' %}selected{% endif %}>âœ… Ù…ÙƒØªÙ…Ù„Ø©</option>
            </select>
          </form>
        </td>
        <td>
          <a href="{% url 'task_details' task.id %}" target="_blank">ğŸ‘ï¸ Ø¹Ø±Ø¶</a>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{# âœ… Ø§Ù„Ø¨Ø§Ø¬ÙŠÙ†Ø§Ø´Ù† #}
{% if is_paginated %}
  <div class="pagination" style="margin-top:20px; text-align:center;">
    <ul style="list-style:none; display:inline-flex; gap:5px; padding:0;">

      {% if page_obj.has_previous %}
        <li><a href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.site %}&site={{ request.GET.site }}{% endif %}">â®ï¸ Ø§Ù„Ø£ÙˆÙ„Ù‰</a></li>
        <li><a href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.site %}&site={{ request.GET.site }}{% endif %}">â—€ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</a></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li><strong style="padding:5px 10px; background:#ddd; border-radius:5px;">{{ num }}</strong></li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li><a href="?page={{ num }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.site %}&site={{ request.GET.site }}{% endif %}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li><a href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.site %}&site={{ request.GET.site }}{% endif %}">Ø§Ù„ØªØ§Ù„ÙŠ â–¶ï¸</a></li>
        <li><a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.site %}&site={{ request.GET.site }}{% endif %}">â­ï¸ Ø§Ù„Ø£Ø®ÙŠØ±Ø©</a></li>
      {% endif %}

    </ul>
    <div style="margin-top:10px; font-weight:bold;">
      ØµÙØ­Ø© {{ page_obj.number }} Ù…Ù† {{ page_obj.paginator.num_pages }}
    </div>
  </div>
{% endif %}

{% endblock %}
